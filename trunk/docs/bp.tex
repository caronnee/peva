\documentclass[11pt,final]{fithesis}

\usepackage{a4wide}

\usepackage{czech}

\usepackage{amssymb,amsthm,amsmath}

\usepackage{url}

\usepackage[colorlinks]{hyperref}

\usepackage{graphicx}

\usepackage{fancybox}

\usepackage{shortlst}

\usepackage{algpascal}

\thesistitle{Rozvrhování pomocí logického programování s omezujícími podmínkami}
\thesissubtitle{Bakaláøská práce}
\thesisstudent{Martin ©mérek}
\thesiswoman{false}
\thesisfaculty{fi}
\thesisyear{jaro 2006}
\thesisadvisor{Mgr. Hana Rudová, Ph.D.}

%---Vlastní-definice-----------------

% Makra
\def\ecl{ECL$^{i}$PS$^{e}$}

% Poèe¹tìní poznámky a definice
\theoremstyle{remark}
\newtheorem*{pozn}{Poznámka}

\theoremstyle{definition}
\newtheorem{definice}{Definice}

\newtheorem{priklad}{Pøíklad}

\renewcommand{\proofname}{Dùkaz}

%------------------------------------

\begin{document}

\FrontMatter

\ThesisTitlePage

\begin{ThesisDeclaration}
  \DeclarationText
  \AdvisorName
\end{ThesisDeclaration}

\begin{ThesisThanks}
Rád bych podìkoval vedoucí své bakaláøské práce Mgr. Hanì Rudové, Ph.D. za vìnovaný èas a úsilí. Dále bych rád podìkoval rodièùm za podporu a Irence Zbiejczukové nejen za jazykovou korekturu.

\medskip

\noindent{Tato práce byla podporována Ministerstvem ¹kolství, mláde¾e a tìlovýchovy Èeské republiky v rámci výzkumného zámìru è. 0021622419.}
\end{ThesisThanks}

\begin{ThesisAbstract}
Práce prezentuje sadu statických a dynamických rozvrhovacích problémù øe¹ených logickým programováním s omezujícími podmínkami. Pro ka¾dý problém je popsán jeho model, mo¾nosti øe¹ení a implementace. Statické problémy jsou øe¹eny pomocí knihovny pro práci nad koneènými doménami, dynamické problémy jsou øe¹eny pomocí lokálního prohledávání prostøednictvím hybridního øe¹ièe.
\end{ThesisAbstract}

\begin{ThesisKeyWords}
Splòování podmínek, logické programování s omezujícími podmínkami, rozvrhování, dynamické problémy
\end{ThesisKeyWords}

\MainMatter
\tableofcontents

%------------------------------------
\chapter{Úvod}

  Cílem této balaláøské práce je studium mo¾ností øe¹ení rozvrhovacích problémù pomocí logického programování s~omezujícími podmínkami \cite{dechter:cp03}. Práce se zabývá klasickým i dynamickým rozvrhováním úloh na disjunktních i kumulativních zdrojích \cite{bidot:su05}. Pro úèely øe¹ení statických problémù, tedy problémù, jejich¾ celé zadání je pevnì dané, jsou prozkoumány mo¾nosti tradièní implementace prohledávání stavového prostoru pomocí backtrackingu. Práce dále studuje problémy, jejich¾ zadání je v prùbìhu èasu mìnìno, a zpùsob jejich øe¹ení s vyu¾itím  lokálního prohledávání, jeho¾ pou¾ití není v logickém programování s~omezujícími podmínkami èasté.

  Práce nepøedpokládá znalosti z oblasti logického programování s omezujícími podmínkami a následující kapitola je proto vìnována struènému úvodu do problematiky. Je zde definován problém splòování podmínek a jeho roz¹íøení na optimalizaèní problém s~omezujícími podmínkami a dále pak dynamický problém splòování podmínek. Dále je vysvìtlena základní struktura logického programu s omezujícími podmínkami a  obecnì popsány pou¾ité metody prohledávání. Poslední èást kapitoly je vìnována knihovnì pro detekci nesplnìných omezení, která umo¾òuje implementaci lokálního prohledávání.

  V dal¹í kapitole jsou popsány klasické rozvrhovací problémy a zpùsoby jejich øe¹ení pomocí øe¹ièe omezujících podmínek nad koneènými doménami. U ka¾dého problému je uveden konkrétní pøíklad, popsáno jeho modelování pomocí omezujících podmínek a navrhnuta metoda prohledávání.

  Kapitola vìnovaná dynamickým rozvrhovacím problémùm popisuje zpùsob, jak si lze poradit se zmìnami v zadání rozvrhovacích problémù. Je zde popsáno vyu¾ití knihovny pro detekci nesplnìných omezení pøi implementaci lokálního prohledávání a ukázány výhody propojení této knihovny s øe¹ièem nad koneènými doménami do tzv. hybridního øe¹ièe. V této kapitole je také navr¾en nový zpùsob umo¾òující detekci nesplnìných omezení na disjunktních a kumulativních zdrojích.

  V poslední kapitole jsou prezentovány experimentální výsledky namìøené pro instance øe¹ených problémù. Navrhnutá øe¹ení v¹ech uvedených problémù byla implementována v~systému \ecl{} \cite{ecl:intro05,ecl:clp05}.

%------------------------------------
\chapter{Logické programování s omezujícími podmínkami}
  \label{chap:clp}

% - - - - - - - - -
    Logické programování s omezujícími podmínkami \cite{dechter:cp03} (\emph{Constraint Logic Programming} -- dále jen CLP) spojuje dvì deklarativní paradigmata: programování s omezujícími podmínkami (\emph{Constraint Programming}) a logické programování. V této kapitole bude nejdøíve vysvìtlen princip, na kterém pracuje programování s omezujícími podmínkami, následnì bude ukázána základní struktura CLP programu a obecnì popsán zpùsob øe¹ení problémù pomocí CLP a základní pou¾ívané techniky.

% - - - - - - - - -
  \section{Problém splòování podmínek}

    Problém splòování podmínek \cite{dechter:cp03,baptpanui:cbs01}(\emph{Constraint Satisfaction Problem} -- dále jen CSP) je ústøedním pojmem programování s omezujícími podmínkami. CSP obsahuje koneènou mno¾inu doménových promìnných (\emph{variables}), kde ka¾dá promìnná mù¾e nabývat hodnot z pøíslu¹né domény (\emph{domain}). Nad mno¾inami promìnných jsou pak definována omezení (\emph{constraints}), která specifikují pøípustné kombinace hodnot promìnných.

    \begin{definice}
      Problém splòování podmínek je trojice $(V,D,C)$, kde 
      \begin{itemize}
	\item $V = \{ v_1 , \dots , v_n \}$ je koneèná mno¾ina promìnných,
	\item $D = \{ D_1 , \dots , D_n \}$ je koneèná mno¾ina domén -- ka¾dá $D_i$ je mno¾ina hodnot, kterých mù¾e nabývat promìnná $v_i$,
	\item $C = \{ c_1 , \dots , c_m \}$ je koneèná mno¾ina omezení. Ka¾dé omezení $c_i$ je relace definovaná na podmno¾inì $ \{ v_{i_1} , \dots , v_{i_k} \} $ mno¾iny $V$, tedy $c_i \subseteq D_{i_1} \times \dots \times D_{i_k}$.
      \end{itemize}
    \end{definice}

    \begin{pozn}
      V této práci budeme jako domény promìnných uva¾ovat koneèné mno¾iny celých èísel.
    \end{pozn}

    \begin{priklad}
      Uva¾ujme promìnné $A$, resp. $B$, jejich¾ doménami jsou mno¾iny $D_A=\{1,2,3\}$, resp. $D_B=\{2,3,4\}$. Dále uva¾me omezení $c$ nad $A \times B$, které je explicitnì zadáno takto $c=\{(2,2),(3,2),(3,3)\}$. Odpovídající implicitní vyjádøení omezení $c$ je $A \geq  B$ a problém splòování podmínek je napøíklad $(\{A,B\},\{D_A,D_B\},\{c\})$.
    \end{priklad}    

    V okam¾iku, kdy známe deklarativní vyjádøení problému, mù¾eme zaèít uva¾ovat, zda a jaké má zadaný problém øe¹ení. Øe¹ením bude patrnì pøiøazení hodnot v¹em promìnným takovým zpùsobem, ¾e toto pøiøazení neodporuje vstupním podmínkám. Pro formální definici øe¹ení CSP nejdøíve zavedeme pojem splnìní podmínky:

    \begin{definice}
      Omezující podmínka $c$ nad promìnnými $v_{c_1}, \dots , v_{c_k}$ je pro pøiøazení hodnot $d_{c_1} \in D_{c_1}, \dots, d_{c_k} \in D_{c_k}$ pøíslu¹ným promìnným splnìna (\emph{satisfied}), pokud $(d_{c_1}, \dots ,d_{c_k}) \in c$. V opaèném pøípadì øíkáme, ¾e je omezení nesplnìno (\emph{unsatisfied}) èi poru¹eno (\emph{violated}).
    \end{definice}

    \noindent{Formálnì mù¾eme pojem øe¹ení CSP definovat takto:}

    \begin{definice}
      Úplné pøiøazení hodnot promìnným je øe¹ením $(V,D,C)$, pokud pro v¹echna $c \in C$ platí, ¾e jsou tímto pøiøazením splnìna.
    \end{definice}

    \begin{pozn}
      Z definice je zøejmé, ¾e mù¾e nastat situace, kdy CSP nemá ¾ádné øe¹ení -- pak mluvíme o pøíli¹ omezeném (\emph{over-constrainted}) nebo také nekonzistentním (\emph{inconsistent}) CSP. Na¹e po¾adavky na øe¹ení pak musíme zeslabit (\emph{relax}), tj. odstranit nebo zmírnit jedno èi více omezení.
    \end{pozn}

    \begin{priklad}
      Mìjme promìnné $A \in \{1,2\}$, $B \in \{2,3\}$ a $C \in \{1,3\}$ a omezení $A \neq B$, $B \neq C$ a $C \neq A$. Øe¹eními odpovídajícího CSP jsou pøiøazení $A=1, B=2, C=3$ a $A=2, B=3, C=1$. ®ádné dal¹í ohodnocení promìnných není øe¹ením.
    \end{priklad}
   
    Pøi øe¹ení problémù s omezujícími podmínkami èasto nastane situace, kdy má zadaný problém mnoho rùzných øe¹ení. V praxi je pak po¾adováno øe¹ení, které je v urèitém smyslu \uv{nejlep¹í}. Abychom mohli porovnat kvalitu jednotlivých øe¹ení, zavádíme objektivní funkci z mno¾iny øe¹ení do uspoøádané mno¾iny (nejèastìji do mno¾iny celých èísel). Formálnì mù¾eme takové roz¹íøení CSP popsat následovnì:

    \begin{definice}
      Nech» $P$ je CSP, $Sol$ je mno¾ina jeho øe¹ení a $f:Sol \rightarrow \mathbb Z$ je objektivní funkce. Optimalizaèní problém s omezujícími podmínkami (\emph{Constraint Satisfaction Optimization Problem} -- dále jen CSOP) je problém $P$ spolu s objektivní funkcí $f$. Øe¹ením CSOP je øe¹ení problému $P$ minimalizující hodnotu funkce $f$.
    \end{definice}

    \begin{pozn}    
      Problém maximalizace hodnoty objektivní funkce mù¾e být snadno pøeveden na námi zadefinovaný CSOP pouhým vynásobením hodnoty objektivní funkce $f$ èíslem $-1$.
    \end{pozn}
    
    U mnoha problémù je nalezení optimálního øe¹ení slo¾ité, a proto u tìchto problémù staèí najít sub-optimální øe¹ení, tedy øe¹ení, které je svým ohodnocením dostateènì blízko optimálnímu øe¹ení problému.

  Z definice problému s omezujícími podmínkami je zøejmé, ¾e se jedná o problém, jeho¾ celé zadání je známé ji¾ pøed zaèátkem jeho øe¹ení. Pokud uva¾íme situaci, kdy s postupujícím èasem pøidáváme do problému dal¹í promìnné a omezující podmínky, dostáváme roz¹íøení pùvodní definice CSP na dynamický problém splòování podmínek \cite{kocjan:ds02,miguel:dyn04}(\emph{Dynamic Constraint Satisfaction Problem} -- dále DCSP).

    \begin{definice}
        Dynamický problém splòování podmínek je posloupnost problémù splòování podmínek, kde ka¾dý CSP je výsledkem zmìny problému pøedchozího. Rozdíl mezi dvìma po sobì následujícími CSP vyjadøují mno¾ina pøidaných omezení $C_{add}$ a mno¾ina odebraných omezení $C_{del}$.
    \end{definice}

% - - - - - - - - -
  \section{Struktura CLP programu}

    Spojení  omezujících podmínek s logickým programováním je velice pøirozené. Pro vyøe¹ení musí být CSP nejdøíve deklarativnì zadán a následnì nalezeno jeho øe¹ení. Obì tyto oddìlené èásti lze snadno vyjádøit právì logickým programováním. CLP roz¹iøuje logické programování tím, ¾e místo standardní unifikace je pou¾ito splòování podmínek (\uv{rovnost} pouze jedním z mo¾ných omezení).

    CLP systémy rozli¹ujeme podle domén a typu promìnných, se kterými pracují. Skuteènost, ¾e CLP systém pracuje nad urèitou doménou, vyjadøujeme zápisem CLP($X$), kde $X$ je tato doména. Existují napøíklad systémy CLP($\mathbb R$) (pro práci s reálnými èísly), CLP($\mathbb Z$) (pro celá èísla) a CLP($FD$) (pro práci s koneènými doménami -- \emph{finite domains}). Problém splòování podmínek mù¾e být øe¹en právì pomocí CLP($FD$) knihoven ve standardních prostøedích Prologu -- v této práci je pou¾it intervalový øe¹iè knihovny \emph{ic}, který je v systému \ecl{} pou¾íván pro práci s promìnnými nad koneènými doménami \cite{ecl:intro05,ecl:clp05}. Jiným pøíkladem je øe¹iè systému SICStus Prolog \cite{sics:man02}.
    Základní struktura CLP programù je v¾dy stejná: nejdøíve jsou nadefinovány promìnné a jejich domény, následnì jsou nad doménovými promìnnými definovány omezující podmínky a nakonec je pomocí pøeddefinované procedury prohledáván stavový prostor (tato procedura je v anglicky psané literatuøe nazývána \emph{labeling}) a nalezeno (pøípadnì nenalezeno) øe¹ení problému. Popsaná struktura mù¾e být pøepsána do CLP programu, který je na obrázku \ref{fig:csp}.

  \begin{figure}[thb]
	\centering
	\begin{minipage}{9cm}
	  \begin{verbatim}

  CLP_program( Promenne ) :-
      definice_promennych( Promenne ),
      definice_omezeni( Promenne ),
      hledani_reseni( Promenne ).
          \end{verbatim}
	\end{minipage}
    \caption{Základní struktura CLP programu.}
    \label{fig:csp}
  \end{figure}

% - - - - - - - - -
\section{Omezení a jejich propagace}

    Propagace omezení \cite{dechter:cp03} je mechanismus, který umo¾òuje odstranit z domén promìnných hodnoty, které nemohou být souèástí øe¹ení problému (tzv. \emph{nekonzistentní hodnoty}). Problém, který vznikne odstranìním nekonzistentních hodnot, je ekvivalentní s pùvodním problémem (odstranìny byly pouze hodnoty, které nemohly mít vliv na podobu øe¹ení) a zároveò je jeho zjednodu¹ením (prohledávaný stavový prostor je men¹í).

    Nejjednodu¹¹í omezení, o jejich¾ propagaci mù¾eme uva¾ovat, jsou unární podmínky. Jejich propagace spoèívá v pøevedení podmínek do domén promìnných. U binárních omezení je situace slo¾itìj¹í, proto¾e pro rozsáhlej¹í problémy je nemo¾né vyjadøovat omezení explicitnì. Proto je potøeba zajistit propagaci tìchto podmínek pouze pomocí jejich implicitního vyjádøení. Jedna z cest, jak tohoto dosáhnout, je zavedení hranové konzistence (\emph{arc consistency}), která zaji¹»uje, ¾e ka¾dá hodnota v doménì první promìnné je konzistentní s~alespoò jednou hodnotou z domény druhé promìnné. 

    Dosáhnout hranové konzistence je mo¾né, vzhledem k poètu omezení a maximální velikosti domény, v polynomiálním èase. Je u¾iteèné si uvìdomit, ¾e pøesto¾e se jejím dosa¾ením problém zjednodu¹í, sama hranová konzistence nezaruèuje ani nalezení øe¹ení problému, ani nevypovídá nic o tom, zda problém nìjaké øe¹ení má.

    Pro omezující podmínky se v nìkterých CLP systémech pou¾ívá slab¹í konzistence mezí (\emph{bounds consistency}). Pøi udr¾ování této konzistence dochází k propagaci podmínky pouze pøi zmìnì minimální èi maximální hodnoty v doménì promìnné, tedy pøi zmìnì mezí domény. Výhodou této konzistence je nízká nároènost propagace zmìn, nevýhodou je uchovávání nekonzistentních hodnot v doménách promìnných.

Konzistenci mezí i hranovou konzistenci lze jednodu¹e roz¹íøit i na nebinární (aritmetické) podmínky. Z hlediska efektivity propagace omezení je výhodnìj¹í pou¾ívat místo mno¾iny omezení, které spolu souvisí, tzv. globální omezující podmínky (\emph{Global Constraints}). \uv{Globální} pohled na omezení umo¾òuje pou¾ití speciálních propagaèních technik, èím¾ lze znaènì zvý¹it výkon systémù s omezujícími podmínkami. Dal¹í výhodou pou¾ití globální podmínky je zjednodu¹ení modelu problému -- globální omezení vìt¹inou nemají pevnì danou aritu.

% - - - - - - -
\section{Metody prohledávání}

   V této práci budeme pou¾ívat dvì základní prohledávací procedury \cite{dechter:cp03,burke:sm05} -- úplné stromové prohledávání pomocí metody vìtví a mezí \cite{dechter:cp03} (\emph{Branch and Bound}) a neúplné lokální prohledávání \cite{burke:sm05} (\emph{Local Search}).

   Metoda vìtví a mezí je základní konstrukèní algoritmus pou¾ívaný pro optimalizaèní problémy. Algoritmus hledá øe¹ení pomocí backtrackingu s propagací podmínek a vede si záznam o nejlep¹ím zatím dosa¾eném øe¹ení, jeho¾ cenu pou¾ívá jako horní mez (\emph{upper bound}). Pøi prohledávání se pou¾ívá heuristická funkce, která ohodnocuje parciální øe¹ení -- tato funkce reprezentuje nejlep¹í mo¾nou cenu øe¹ení, které mù¾eme získat roz¹íøením souèasného pøiøazení hodnot promìnným (tuto funkci oznaèujeme jako dolní mez -- \emph{lower bound}). V¾dy, kdy¾ je pøiøazena hodnota promìnné, je pro souèasné pøiøazení promìnných vypoètena dolní mez. Pokud dolní mez pøekroèí horní mez, podstrom pod souèasným pøiøazením nemù¾e obsahovat optimální øe¹ení a nemusí být tedy prohledáván.

   Algoritmus lokálního prohledávání pracuje s úplným, ne nutnì konzistentním pøiøazením promìnných -- stavem. Ohodnocení ka¾dého stavu vyjadøuje poèet nesplnìných omezujících podmínek. Prohledávání je realizováno pomocí malých lokálních zmìn. Mno¾ina stavù, které se li¹í od souèasného právì v jedné lokální zmìnì, se nazývá okolí (\emph{neighborhood}). V~ka¾dém kroku je vybírán stav z okolí (typicky nejlépe ohodnocený), na který je souèa¹ný stav zmìnìn. Cílem lokálních zmìn je nalezení konzistentního úplného pøiøazení hodnot promìnným. Kostru lokálního prohledávání mù¾eme vidìt na obrázku \ref{fig:ls}.
\begin{figure}[htb]
      \begin{algorithmic}[1]
	\Procedure{LocalSearch}{(PocetPokusu,PocetZmen)}
        \State $\sigma \gets$ iniciální ohodnocení promìnných
        \For{i=1}{\text{PocetPokusu}}
	  \Begin
          \For{j=1}{\text{PocetZmen}}
	    \Begin
            \If {\sigma \text{ je konzistentní pøiøazení}}
                \State \textbf{return} $\sigma$
            \State vyber $\delta$ z okolí $\sigma$
            \If {\delta \text{ je akceptovatelné}}
              \State $\sigma \gets \delta$
            \End
	  \State $\sigma \gets$ nové ohodnocení promìnných
	  \End
        \State \textbf{return} nejlep¹í dosa¾ený stav $\sigma$
      \end{algorithmic}
      \caption{Kostra algoritmu lokálního prohledávání}
  \label{fig:ls}
\end{figure}

  Z popisu lokálního prohledávání je zøejmé, ¾e se jedná pouze o obecnou metodu -- v této práci pou¾ijeme konkrétní typ, minimalizaci konfliktù \cite{jv:cs05} (\emph{Conflict Minimization}) v kombinaci s náhodnou procházkou \cite{burke:sm05} (\emph{Random Walk}). Minimalizace konfliktù vybírá náhodnou promìnnou, která je v konfliktu, a sna¾í se minimalizovat poèet omezení poru¹ených pøiøazením této promìnné. Pokud se algoritmu nepodaøí zmen¹it poèet konfliktù, náhodnì vybírá vybírá dal¹í promìnnou a postup opakuje. Pokud lze zmìnou hodnoty promìnné sní¾it poèet konfliktù, promìnné je pøiøazena hodnota, která poèet konfliktù minimalizuje. Metoda náhodné procházky s velmi malou pravdìpodovností náhodnì zmìní náhodnou promìnnou.

% - - - - - - - - -
  \section{Knihovna pro detekci nesplnìných omezení}
  \label{sec:repair}
  Systém \ecl{} obsahuje knihovnu \emph{repair} \cite{ecl:clp05,ecl:intro05}, která umo¾òuje detekci nesplnìných omezení. Na základì informací o nesplnìných (poru¹ených) podmínkách je potom mo¾né implementovat napøíklad lokální prohledávání. Proto¾e standardní CLP pøístup neumo¾òuje zmìnu hodnoty ji¾ jednou instanciované promìnné, nabízí knihovna \emph{repair} pro tyto úèely mechanismus zku¹ebních hodnot (\emph{tentative value}), který se od klasického pøístupu li¹í zejména v tìchto tøech vlastnostech:
\begin{itemize}
\item zku¹ební hodnoty mohou být mìnìny %
\item nedochází k propagaci podmínek %
\item zku¹ební hodnoty nejsou omezeny doménami promìnných %
\end{itemize}
\noindent{Dodejme je¹tì, ¾e jedna promìnná mù¾e mít svou doménu promìnných a zároveò jednu zku¹ební hodnotu. Stejnì mù¾e jedna promìnná figurovat v omezení rùzných knihoven.}

Aby bylo mo¾né omezení sledovat (monitorovat), zda je omezení pøi daném pøiøazení zku¹ebních hodnot promìnných splnìno nebo ne, tak jej musíme deklarovat jako omezení nad zku¹ebními hodnotami takto:

  \begin{minipage}{\textwidth}
    \centering
    \begin{verbatim}

              Omezeni r_conflict Mnozina_omezeni
    \end{verbatim}
  \end{minipage}

  K mno¾inì poru¹ených omezení a konfliktních promìnných lze pøistupovat pomocí atomu {\verb Mnozina_omezeni }, který pou¾ijeme jako argument pøi volání predikátù 

  \begin{minipage}{\textwidth}
  \begin{verbatim}

  conflict_constraints(Mnozina_omezeni, Porusena_omezeni), 
  poss_conflict_vars(Mnozina_omezeni, Konfliktni_promenne).
  \end{verbatim}
  \end{minipage}

Predikát \verb|conflict_constraints/2| slou¾í ke zji¹tení mno¾iny porusenych omezeni a predikát \verb|poss_conflict_vars/2| umo¾ní nalézt v¹echny promìnné, které se nacházejí v~poru¹ených omezeních.

%------------------------------------
\chapter{Statické rozvrhovací problémy}

% - - - - - - - - -

      V této kapitole se budeme zabývat statickými rozvrhovacími problémy, tedy takovými rozvrhovacími problémy, jejich¾ úplné zadání je známé pøed zaèátkem jejich øe¹ení.

  Rozvrhovací problém \cite{baptpanui:cbs01,brucker:sa98}(\emph{scheduling problem}) mù¾e být definován jako problém pøidìlení (limitovaných) zdrojù (\emph{resource}) aktivitám (\emph{activity}) probíhajícím v èase. Rozvrhovací problém se skládá z mno¾iny $n$ aktivit èi úloh (\emph{task}) $\{ A_1, \dots A_n \}$ a mno¾iny $m$ zdrojù $\{ R_1, \dots R_n \}$. Pro ka¾dou aktivitu je daný èas, který je potøeba k jejímu zpracování, a kapacita, kterou vy¾aduje po dobu svého bìhu od jednoho èi více zdrojù. Ka¾dý zdroj má danou kapacitu, která nemù¾e být v ¾ádném èasovém okam¾iku pøekroèena. Dále mù¾e problém obsahovat èasová omezení aktivit (startovní èas, èas dostupnosti úlohy, atd.), omezení týkající se vzájemného vztahu rùzných aktivit (napø. precedenèní podmínky -- aktivita $A_i$ nesmí zaèít pøed koncem aktivity $A_j$) a ohodnocovací funkci (\emph{cost function}). Pro vyøe¹ení problému je tøeba rozhodnout, kdy zaèít zpracovávat jednotlivé úlohy tak, aby byla minimalizována celková cena rozvrhu a byla zachována v¹echna omezení. V této práci se budeme dr¾et tohoto znaèení:
      \begin{itemize}
	\item $p_i$ (\emph{processing time}) je èas potøebný k zpracování aktivity $A_i$,
	\item $r_i$ (\emph{release date}) je èas dostupnosti aktivity $A_i$ (tj. nejdøívìj¹í okam¾ik, kdy mù¾e být aktivita spu¹tìna),
	\item $d_i$ (\emph{due date}) je èasový okam¾ik, pøed kterým musí být aktivita $A_i$ dokonèena,
	\item $cap_i$ (\emph{capacity}) je kapacita, kterou aktivita $A_i$ po¾aduje v ka¾dý okam¾ik svého bìhu,
	\item $start_i$ je èas spu¹tìní aktivity $A_i$,
	\item $end_i$ je èas dokonèení aktivity $A_i$ -- pøi pevném $p_i$ platí: $end_i = start_i + p_i$.
      \end{itemize}
      
      \begin{pozn}
	Pøi øe¹ení rozvrhovacích problémù pova¾ujeme èas za diskrétní velièinu -- pøi øe¹ení reálných rozvrhovacích problémù se èasto poèítá s jednotkou, na její¾ úrovni je¹tì rozli¹ujeme (5 minut, vyuèovací hodina, pracovní smìna, apod.).
      \end{pozn}

  \noindent{Podle typu zdroje rozli¹ujeme:}
      \begin{itemize}
	\item disjunktivní rozvrhování (\emph{Disjunctive Scheduling}) -- uva¾ujeme zdroje s kapacitou 1 (zdroj mù¾e zpracovávat nejvý¹e jednu aktivitu v jednom èasovém okam¾iku).
	\item kumulativní  rozvrhování (\emph{Cumulative Scheduling}) -- zdroj mù¾e zpracovávat více aktivit zároveò za pøedpokladu, ¾e není pøekroèena jeho kapacita.
      \end{itemize}
\newpage
  \noindent{Podle typu úloh mù¾eme rozli¹it napø.:}
      \begin{itemize}
	\item elastické rozvrhování (\emph{Elastic Scheduling}) -- kapacita, kterou aktivita na zdroji po¾aduje, mù¾e v ka¾dém okam¾iku nabývat hodnoty z (diskrétního) intervalu $\langle 0, c_i \rangle$. Souèet kapacit se pak musí rovnat zadané hodnotì (\emph{energy}).
	\item preemptivní rozvrhování (\emph{Preemptive Scheduling}) -- bìh ka¾dé aktivity mù¾e být nìkolikrát pøeru¹en (vìt¹inou je povolení pøeru¹ení vázáno na urèitou podmínku).
	\item nepreemptivní rozvrhování (\emph{Non-Preemptive Scheduling}) -- bìh aktivity nemù¾e být pøeru¹en a po¾adavky na zdroje jsou konstantní. Dále se budeme zabývat pouze tímto typem problémù.
      \end{itemize}

      Dal¹í charakteristiky úloh a zdrojù jsou popsány napø. Grahamovou klasifikací \cite{baptpanui:cbs01,brucker:sa98}.

% - - - - - - - - -
  \section{Plánování projektu}
  \label{sec:project}

  Prvním rozvrhovacím problémem, který byl v rámci práce øe¹en, je základní problém plánování projektu \cite{pinedo:ps05} (\emph{Project Scheduling Problem}). Tento problém poskytuje vhodný základ pro øe¹ení slo¾itìj¹ích problémù a zároveò ukazuje, jakým zpùsobem lze modelovat precedenèní podmínky.

  \subsection{Popis problému}
  Problém plánování projektu lze popsat takto:
   \begin{itemize}
     \item máme $n$ aktivit, ka¾dá aktivita $A_i$ pro $1 \leq i \leq n $ má zadán èas dostupnosti $r_i$ a dobu trvání $p_i$,
     \item rozvrh je omezen precedenèními podmínkami -- pro nìkteré dvojice aktivit $A_i$ a $A_j$ po¾adujeme, aby $end_i \leq start_j$ (znaèíme $A_i \ll A_j$),
     \item k dispozici máme neomezené mno¾ství zdrojù,
     \item kritériem optimality je minimalizace koncového èasu v¹ech aktivit (\emph{makespan}).
   \end{itemize}

   \begin{priklad}
     Uva¾me problém obsahující a aktivity $A_1, \dots ,A_6$:
     \begin{shortitemize}
       \item $r_1 = 2$, $p_1 = 2$ %
       \item $r_2 = 6$, $p_2 = 3$ %
       \item $r_3 = 0$, $p_3 = 7$ % 
       \item $r_4 = 2$, $p_4 = 2$ %
       \item $r_5 = 0$, $p_5 = 3$ %
       \item $r_6 = 1$, $p_6 = 3$  
     \end{shortitemize} %
     s precedenèními podmínkami $A_1 \ll A_2$, $A_2 \ll A_4$, $A_3 \ll A_6$, $A_5 \ll A_2$ a $A_6 \ll A_4$.
     Jedno z~optimálních øe¹ení mù¾eme vidìt na obrázku \ref{fig:proj} -- cena optimálního øe¹ení je 12.
\begin{figure}[hbt]
\centering
\begin{minipage}{5in}
\centering
\includegraphics{figures/proj.eps}
\caption{Optimální øe¹ení pro minimalizaci makespan}
\label{fig:proj}
\end{minipage}
\end{figure}
   \end{priklad}
  
  \subsection{Model v CLP}

   První èástí modelu tohoto CSP je definice promìnných a jejich domén. Promìnné v na¹em pøípadì pøedstavují startovní èasy úloh. Dostupnost úloh $r_i$ je obsa¾ena v dolních mezích domén tìchto promìnných. Ani v nejhor¹ím pøípadì (kdyby kvùli precedenèním podmínkám byla zpracovávána nejvý¹e jedna aktivita v jeden okam¾ik) nemù¾e celkový èas potøebný na zpracování v¹ech úloh pøesáhnout $max_{i=1..n} r_i + \sum_{i=1}^n (p_i)$, proto tedy mù¾eme tuto sumu pou¾ít jako horní mez domén startovních èasù aktivit. Stejnì mù¾eme nastavit i horní hranici promìnné reprezentující èas konce rozvrhu.

   Jediné podmínky, které jsou na rozvrh kladeny, jsou precedence. Tyto mù¾eme modelovat tak, ¾e pro ka¾dou dvojici takovou, ¾e $A_i \ll A_j$ pøidáme omezení $start_i + p_i \leq start_j$ (v~\ecl{} zapí¹eme \texttt{Start\_i + P\_i \#=< Start\_j}). Propagace omezení zajistí tranzitivitu precedencí: 

  \begin{tabular}{l@{$\ \Rightarrow \ $}l}
  $ A_i \ll A_j \wedge A_j \ll A_k$ & $start_i + p_i \leq start_j \wedge start_j + p_j \leq start_k$ \\
  & $start_i + p_i + p_j \leq start_k$ \\
  & $A_i \ll A_k$
  \end{tabular}

  \noindent{Celkový èas $total$ získáme omezením $total = max(end_1, \dots , end_n)$, které mù¾eme v systému \ecl{} zapsat jako \texttt{maxlist([End\_1,...,End\_n], Total)}.}


  \subsection{Pou¾itá metoda prohledávání}

  K vyøe¹ení tohoto problému mù¾e být pou¾ita metoda kritické cesty \cite{pinedo:ps05} (\emph{Critical Path Method}), která vyu¾ívá grafové reprezentace problému a v grafu hledá kritickou cestu -- mno¾inu úloh, jejich¾ nejdøívìj¹í startovní èas se rovná nejpozdìj¹ímu startovnímu èasu. Uká¾eme, jak lze touto metodou problém øe¹it pomocí CLP a propagace omezujících podmínek.

  Dolní mez domény promìnné $start_i$ pro $1 \leq i \leq n $ je $r_i$ v pøípadì, ¾e úloha nemá ¾ádné pøedchùdce a maximum z nejdøívìj¹ích koncových èasù pøedchùdcù v opaèném pøípadì. Proto¾e na zdroj nejsou kladena ¾ádná omezení, mù¾eme nyní promìnným pøiøadit hodnotu dolní meze jejich domény, èím¾ získáme optimální øe¹ení.
  
% - - - - - - - - -
  \section{Disjunktivní rozvrhování pro jeden stroj}
  \label{sec:disj}

  Prvním typem zdroje, který budeme v rozvrhovacích úlohách uva¾ovat, je jeden zdroj s~jednotkovou kapacitou. Na tomto pøíkladu uká¾eme práci s rùznými kritérií optimality a omezenými zdroji. Bude nám také slou¾it jako základ pro øe¹ení slo¾itìj¹ího problému øe¹eného v \ref{sec:jobs}.

  \subsection{Popis problému}
  Uva¾ovaný problém obsahuje:
   \begin{itemize}
     \item $n$ aktivit, ka¾dá s èasem dostupnosti $r_i$ a dobou trvání $p_i$,
     \item precedenèní podmínky,
     \item jeden stroj, na kterém lze zpracovávat v jednom okam¾iku jen jednu aktivitu (unární stroj).
   \end{itemize}
   
   Pøi øe¹ení tohoto problému demonstrujeme pou¾ití dvou rozdílných optimalizaèních kritérií. Nejdøíve budeme problém øe¹it pro kritérium minimalizace koncového èasu aktivit. Jako dal¹í kritérium pou¾ijeme minimalizaci zpo¾dìní (\emph{lateness}):
   \begin{itemize}
     \item ka¾dá aktivita má zadán $d_i$ (termín po¾adovaného dokonèení),
     \item cílem je minimalizace výrazu $max(L_1 , \dots , L_n)$, kde $L_i = end_i - d_i$.
   \end{itemize}


   \begin{priklad}
     Mìjme instanci problému obsahující a aktivity $A_1,A_2$ a $A_3$:
     \begin{itemize}
       \item $r_1 = 0$, $p_1 = 5$ a $d_1 = 6$ %
       \item $r_2 = 7$, $p_2 = 3$ a $d_2 = 10$ %
       \item $r_3 = 2$, $p_3 = 4$ a $d_3 = 13$ 
     \end{itemize} %
     s precedenèní podmínkou $A_1 \ll A_2$.
\begin{figure}[hbt]
\centering
\begin{minipage}{5in}
\centering
\includegraphics[width=4in]{figures/disj1.eps}
\caption{Optimální øe¹ení pro minimalizaci makespan}
\label{fig:disj1}
\end{minipage}
\end{figure}    

     Øe¹ení pro první optimalizaèní kritérium mù¾eme vidìt na obrázku \ref{fig:disj1}. Celková cena tohoto øe¹ení pøi minimalizaci \emph{makespan} je
\[ C_{max} = max( start_1 + p_1,  start_2 + p_2, start_3 + p_3 ) = max(5,12,9) =12 \]

Pøi po¾adavku minimalizace zpo¾dìní dostáváme rozvrh zobrazený na obrázku \ref{fig:disj2}. Cena tohoto øe¹ení je
\[ L_{max} = max(end_1 - d_1 ,end_2 - d_2, end_3 - d_3) = max(-1,0,1) = 1 \]
Z porovnání obou øe¹ení je patrné, ¾e optimální øe¹ení problému se pøi pou¾ití rùzných kritérii mohou velice li¹it.

\begin{figure}[htb]
\centering
\begin{minipage}{5in}
\centering
\includegraphics[width=4in]{figures/disj2.eps}
\caption{Optimální øe¹ení pro minimalizaci zpo¾dìní}
\label{fig:disj2}
\end{minipage}
\end{figure}    
   \end{priklad}

  \subsection{CLP model}
  Pro modelování precedenèních podmínek mù¾eme pou¾ít aritmetická omezení ukázaná pøi øe¹ení problému plánování projektu. 

  Pro unární stroj platí, ¾e v jednom okam¾iku mù¾e zpracovávat jen jednu aktivitu. Omezení pro jeho namodelování by tedy mohlo vypadat takto:
 \[ A_i \ll A_j \vee A_j \ll A_i \text{ pro v¹echny vzájemnì rùzné aktivity } A_i,A_j \]
Pro reprezentaci aktivit pou¾íváme startovní èasy a doby trvání, tak¾e dostáváme ekvivalentní podmínku
 \[ \forall i , j \in \mathbb N, i \leq n , j \leq n , i \neq j : start_i + p_i \leq start_j \vee start_j + p_j \leq start_i \]
Toto je ov¹em pouze deklarativní vyjádøení, pøi implementaci se pou¾ívají metody popsané dále. Pro implicitní vyjádøení pou¾ijeme globální podmínku \emph{disjunctive}. Zápis této podmínky v CLP

  \begin{minipage}{\textwidth}
    \centering
    \begin{verbatim}
        disjunctive([Start_1,...,Start_n],[P_1,...,P_n])
    \end{verbatim}
  \end{minipage}

\noindent{popisuje situaci, kdy je $n$ aktivit se startovními èasy {\verb Start_1 },$\dots$,{\verb Start_n } a dobami trvání {\verb P_1 },$\dots$,{\verb P_n } zpracováváno na unárním zdroji.}

  \subsection{Mo¾nosti øe¹ení problému}

  Nyní zmíníme slo¾itost optimalizaèních problémù, které øe¹íme. Pøi po¾adavku minimalizace \emph{makespan} mù¾eme øe¹ení nalézt v polynomickém èase (jak uká¾eme dále), zatímco problém s minimalizací zpo¾dìní je pøi vstupních, potenciálnì nenulových èasech dostupnosti NP-tì¾ký \cite{brkn:cs06}. Jedním ze zpùsobù, jak redukovat nároènost výpoètu, je propagace omezujících podmínek. Pøi disjunktivním rozvrhování lze pou¾ít napøíklad tyto propagaèní algoritmy \cite{baptpanui:cbs01}:
  \begin{itemize}
    \item Hledání hran (\emph{Edge-Finding}) pøidává precedenèní podmínky a èasová omezení na základì informace, zda nìjaká aktivita $A_i$ z urèité mno¾iny $\Omega$ mù¾e, musí èi nesmí být zpracována døíve nebo pozdìji ne¾ v¹echny ostatní aktivity z $\Omega$.
    \item Metoda \emph{Not-First, Not-Last} je pøirozeným doplòkem pøedchozí propagaèní techniky -- vyu¾ívá informace o aktivitách, které nemohou být první (poslední) v rámci aktivit z~urèité mno¾iny $\Omega$.
  \end{itemize}

  \subsection{Pou¾ité metody prohledávání}

  Model problému ji¾ byl ukázán, nyní zbývá najít optimální øe¹ení. Pro minimalizaci maximálního koncového èasu byl v rámci práce navrhnut postup, který problém vyøe¹í bez navracení (\emph{backtracking}), které je obvykle v prohledávacích procedurách nutné pou¾ít. Princip algoritmu spoèívá ve výbìru promìnné s nejmen¹í dolní mezí v ka¾dém kroku a instanciací promìnné reprezentující startovní èas aktivity na hodnotu této dolní meze.
  \begin{proof}
    Nejdøíve uva¾me skuteènost, ¾e pøi hledání øe¹ení je podstatné uspoøádání aktivit na zdroji -- pokud máme aktivity v èase plnì uspoøádané, optimální øe¹ení nalezneme lehce tak, ¾e promìnným reprezentujícím startovní èas pøiøadíme hodnotu rovnou dolní mezi jejich domén. Proto je tedy pro rozhodnutí optimality øe¹ení klíèové uspoøádání aktivit na zdroji.
 
    Pøedpokládejme, ¾e poøadí aktivit (uspoøádání bereme podle startovních èasù) je v optimálním øe¹ení $A_{i_1}, \dots , A_{i_n}$ a v øe¹ení nalezeném navr¾eným prohledávacím algoritmem  $A_{j_1}, \dots , A_{j_n}$. Nech» je dále $A_{j_k}$ první aktivita taková, ¾e $i_k \neq j_k$ a nech» $m$ je její index v~optimálním øe¹ení. Nyní uva¾me situaci, kdy aktivity uspoøádáme \[ A_{i_1}, \dots A_{i_{k-1}} , A_{i_m}, A_{i_k} , \dots , A_{i_{m-1}} , A_{i_{m+1}} , \dots , A_{i_n} \] (tedy ¾e aktivitu $A_{j_k}$ pøesuneme na $k$-té místo v optimálním øe¹ení). Vzhledem k tomu, ¾e èas dostupnosti aktivity $A_{j_k}$ je men¹í èi roven èasu dostupnosti $A_{i_k}$, je toto pøeuspoøádání stále optimálním øe¹ením. Obdobnì mù¾eme odstranit v¹ech rozdíly a zjistíme, ¾e øe¹ení nalezené navr¾eným algoritmem je optimální.
  \end{proof}
  V \ecl{} lze tento postup implementovat pomocí generické prohledávací procedury takto:

  \begin{minipage}{9cm}
    \centering
    \begin{verbatim}
  search( Promenne, 0, smallest, indomain_min, bbs(0), []).
    \end{verbatim}
  \end{minipage}

  Pro øe¹ení problému pøi minimalizaci zpo¾dìní byla pou¾ita metoda vìtví a mezí. Pøi pou¾ití této metody je dùle¾ité vhodnì nastavit mez ceny hledaného øe¹ení. Dolní mez dostaneme jednodu¹e jako cenu øe¹ení relaxovaného problému -- v nìm nebudeme uva¾ovat omezení na zdroji (tedy problém plánování projektu s pøíslu¹ným kritériem). Pokud neuva¾ujeme zdroj, dostáváme dolní mez jako výraz $max( LB(start_i) + p_i - d_i )$ pro $1 \leq i \leq n$, kde výraz $LB(start_i)$ je dolní mez aktuální domény promìnné $start_i$. Vzhledem ke skuteènosti, ¾e ¾ádná aktivita nemù¾e kvùli dobì dostupnosti a precedenèním podmínkám zaèínat pøed touto dobou, je tento dolní odhad ceny optimálního øe¹ení korektní.

  Pøi hledání øe¹ení je velmi dùle¾ité co nejvíce omezit prohledávaný prostor. Kromì horní hranice nalezené metodou vìtví a mezí je také nutné co nejvíce propagovat omezení na zdroji. K tomuto úèelu bylo pou¾ito disjunktivní omezení z knihovny \emph{ic\_edge\_finder3} , které pou¾ívá nejsilnìj¹í propagaci ze v¹ech disjunktivních omezení, které systém \ecl{} nabízí \cite{ecl:clp05}.

% - - - - - - - - -
  \section{Job Shop Problem}
  \label{sec:jobs}

  V tomto problému \cite{pinedo:ps05}, který je zobecnìním problému øe¹eného v \ref{sec:disj}, budeme novì uva¾ovat pøítomnost více zdrojù.

  \subsection{Popis problému}
  \emph{Job Shop problem} obsahuje:
   \begin{itemize}
     \item $m$ strojù (disjunktních zdrojù)
     \item $n$ úloh, z nich¾ ka¾dá musí být provádìna postupnì na v¹ech strojích v pøesnì daném poøadí
     \item kritérium optimality, které po¾aduje minimalizaci celkového trvání rozvrhu
   \end{itemize}
   
   Ka¾dou z $n$ úloh mù¾eme pøevést na $m$ aktivit (se zadaným èasem dostupnosti $r_i$, dobou provádìní $p_i$ a strojem, na kterém musí být provádìny), které musí být provádìny v pevném poøadí.

   \begin{priklad}
     Mìjme instanci problému obsahující úlohy $T_1,T_2$ a $T_3$ ($(i, j)$ oznaème operaci úlohy $T_j$ na stroji $i$):
     \begin{itemize}
       \item $p_{(1,1)} = 2$, $p_{(2,1)} = 1$, $p_{(3,1)} = 4$ s poøadím  $(2,1)$, $(1,1)$, $(3,1)$
       \item $p_{(1,2)} = 3$, $p_{(2,2)} = 5$, $p_{(3,2)} = 3$ s poøadím  $(3,2)$, $(1,2)$, $(2,2)$
       \item $p_{(1,3)} = 5$, $p_{(2,3)} = 2$, $p_{(3,3)} = 5$ s poøadím  $(2,3)$, $(3,3)$, $(1,3)$
     \end{itemize}

     Optimální øe¹ení takto zadaného problému je zobrazeno na obrázku \ref{fig:jobs}. Celková cena tohoto øe¹ení je
\[ C_{max} = max( start_{(3,1)} + p_{(3,1)}, start_{(2,2)} + p_{(2,2)}, start_{(1,3)} + p_{(1,3)} ) = max(13,13,12) =13 \]
   \end{priklad}

\begin{figure}[hbt]
\centering
\begin{minipage}{5in}
\centering
\includegraphics{figures/jobs.eps}
\caption{Optimální øe¹ení problému Job Shop pro minimalizaci makespan}
\label{fig:jobs}
\end{minipage}
\end{figure}    

  \subsection{Mo¾nosti øe¹ení problému}

  Takto zadaný \emph{Job-Shop Scheduling Problem} patøí mezi NP-tì¾ké problémy a i v rámci této tøídy jej lze zaøadit k obtí¾nìj¹ím \cite{brkn:cs06}. Mo¾ným zpùsobem øe¹ení tohoto problému je pou¾ití metody vìtví a mezí zalo¾ené na disjunktivních grafech. Dále lze vyu¾ít pøístupu smí¹eného celoèíselného programování (\emph{Mixed Integer Programming -- MIP}), lokálního prohledávání (\emph{Local Search}) \cite{baptpanui:cbs01} nebo heuristickou metodu posunování kritického místa (\emph{Shifting Bottleneck heuristic}) \cite{abz:sbjs88}. 

  \subsection{CLP model}
  
  Pro namodelování problému mù¾eme uva¾ovat ka¾dou úlohu jako posloupnost $m$ operací. Ka¾dá taková operace bude reprezentována promìnnou $start_{(i,j)}$, kde $i$ je pøíslu¹ný stroj a $T_j$ je úloha, které aktivita patøí. Celou posloupnost akcí úlohy pak reprezentují pøíslu¹né precedenèní podmínky nad jejími aktivitami na jednotlivých strojích.

  Ka¾dý zdroj modelujeme globální podmínkou \emph{disjunctive}, která bude pro $i$-tý stroj omezovat v¹echny promìnné $start_{(i,j)}$ pro $1 \leq j \leq n$ a jejich pøíslu¹né doby trvání.

  \subsection{Pou¾itá metoda prohledávání}

  Pro øe¹ení tohoto optimalizaèního problému jsme vyu¾ili odhad dolní meze ceny øe¹ení. Pro její výpoèet byl pou¾it relaxovaný problém --  disjunktivní rozvrhování na jednom stroji ukázané v pøedchozí kapitole. Tento problém nejdøíve vypoèítáme zvlá¹» pro ka¾dý stroj (uva¾ujeme jen operace na daném stroji) a nejvy¹¹í hodnotu pou¾ijeme jako dolní mez ceny optimálního rozvrhu. K~tomuto úèelu jsme vyu¾ili predikát \emph{tent\_call} z knihovny \emph{repair}. Tento predikát umo¾òuje volat jiný predikát (který v tomto pøípadì øe¹í problém rozvrhování na disjunktním zdroji) bez instanciace promìnných. Promìnné jsou vraceny pouze s nastavenými zku¹ebními hodnotami.
  
  Pro nalezení øe¹ení jsme pou¾ili metodu vìtví a mezí spolu s nejsilnìj¹í propagací disjunktivních podmínek na zdrojích. Vzhledem k výpoèetní slo¾itosti problému je mo¾né v~nìkterých pøípadech zvý¹it po¾adované zlep¹ení horní meze metody vìtví a mezí (implicitnì je toto zlep¹ení nastaveno na hodnotu $1.0$). Pøi hledání øe¹ení slo¾itìj¹ích instancí problému je vhodné nastavit èasový limit a omezit tak dobu prohledávání.
  
% - - - - - - - - -
  \section{RCPSP}

  \label{sec:rcpsp}

  Problém rozvrhování projektu s omezenými zdroji (\emph{Resource-Constrained Project Scheduling Problem} -- dále jen RCPSP) je zobecnìním èi roz¹íøením velké èásti rozvrhovacích problémù \cite{dorndorf:ps02} (vèetnì v¹ech dosud øe¹ených v této práci). Na tomto obecném problému uká¾eme zapojení zdrojù s nejednotkovými kapacitami.

  \subsection{Popis problému}
   RCPSP obsahuje:
   \begin{itemize}
     \item $m$ zdrojù (obecnì kumulativních), ka¾dý zdroj $R_i$ s danou (nenulovou) kapacitou $resource_i$ (pro $1 \leq i \leq m$),
     \item $n$ úloh, z nich¾ ka¾dá musí být provádìna paralelnì na jednom èi více zdrojích, oznaème $cap_{(i,j)}$ kapacitu, kterou úloha $A_j$ po¾aduje bìhem svého bìhu od zdroje $R_i$,
     \item precedenèní vztahy mezi úlohami,
     \item kritérium optimality, po¾adující minimalizaci celkového trvání rozvrhu.
   \end{itemize}
   
   \begin{priklad}
     Problém obsahuje zdroje $R_1$ a $R_2$ o kapacitách $resource_1 = 4$ a $resource_2 = 2$, aktivity $A_1$,$A_2$, $A_3$ a $A_4$:
     \begin{itemize}
       \item $p_1 = 5$, $cap_{(1,1)}=1$ a $cap_{(2,1)}=3$
       \item $p_2 = 3$, $cap_{(1,2)}=1$ a $cap_{(2,2)}=2$
       \item $p_3 = 6$, $cap_{(1,3)}=1$ a $cap_{(2,3)}=2$
       \item $p_4 = 2$, $cap_{(1,4)}=1$ a $cap_{(2,4)}=1$
     \end{itemize} %
     a precedenèní podmínky $A_4 \ll A_2$ a $A_2 \ll A_1$.
\noindent{\begin{figure}[hbt]
\centering
\begin{minipage}{6.25in}
\centering
\includegraphics{figures/rcpsp.eps}
\caption{Optimální øe¹ení RCPSP pro minimalizaci \emph{makespan}}
\label{fig:rcpsp}
\end{minipage}
\end{figure}}

     Optimální øe¹ení takto zadaného problému je zobrazeno na obrázku \ref{fig:rcpsp}. Doba trvání tohoto rozvrhu je 11.
   \end{priklad}

  \subsection{CLP model}

  Pøi pou¾ití kumulativních zdrojù potøebujeme zajistit, aby v ¾ádném okam¾iku rozvrhu nebyla pøekroèena ¾ádná z kapacit zdrojù. Pøirozeným øe¹ením je jednotlivé zdroje rozdìlit do rùzných podmínek, pøièem¾ musí být splnìno omezení \[ \forall t \sum_{start_i \leq t < end_i} cap_i \leq resource_j \text{ pro } 1 \leq j \leq m \]
  K modelování kumulativního zdroje se pou¾ívá globální podmínka \emph{cumulative}, která je v~systému \ecl{} obsa¾ena ve tøech knihovnách. Jednotlivé knihovny nabízejí rùznou sílu propagace podmínky \cite{ecl:clp05}. Zápis této podmínky v CLP

\noindent{
  \begin{minipage}{\textwidth}
    \begin{verbatim}

cumulative([Start_1,...,Start_n],[P_1,...,P_n],[Cap_1,...,Cap_n],R)
    \end{verbatim}
  \end{minipage}
}
\noindent{popisuje situaci, kdy na jednom zdroji s kapacitou {\verb R } je zpracováváno $n$ aktivit se startovními èasy {\verb Start_1 },$\dots$,{\verb Start_n }, dobami trvání {\verb P_1 },$\dots$,{\verb P_n } a po¾adavky na kapacitu zdroje {\verb Cap_1 },$\dots$,{\verb Cap_n }.}

  \subsection{Mo¾nosti øe¹ení a pou¾itá metoda prohledávání}

  RCPSP je NP-tì¾ký problém a pøi jeho øe¹ení se èasto vyu¾ívají rùzné formy lokálního prohledávání \cite{kolhart:hrcpsp99}. Pøi klasickém pøístupu k øe¹ení problému je opìt klíèová propagace podmínek. Pro kumulativní omezení lze pou¾ít tyto propagaèní techniky \cite{baptpanui:cbs01}:
  \begin{itemize}
    \item \emph{Edge-Finding} pro kumulativní zdroje je zobecnìním pøípadu disjunktního zdroje, stejnì tak i \emph{Not-First, Not-Last}
    \item \emph{Energetic Reasoning} je pomalej¹í ne¾ pøede¹lé dvì uvedené techniky, ale propaguje více zmìn, tak¾e doká¾e odstranit více nekonzistentních hodnot
  \end{itemize}

  Pro hledání øe¹ení byla pou¾ita metoda vìtví a mezí s propagaèním algoritmem pro kumulativní omezení \emph{Edge-Finding}, který nabízí knihovna \emph{ic\_edge\_finder3}.



%------------------------------------
\chapter{Dynamické rozvrhovací problémy}
\label{chap:dyn}
% - - - - - - - - -

  Pøi øe¹ení rozvrhovacích problémù v praxi je èasto po¾adováno, aby byl vypoèítaný rozvrh zmìnìn podle novì dodaných specifik \cite{bidot:su05} (napø. mù¾e být pøidána nebo odebrána aktivita èi mno¾ina aktivit, pøidána precedenèní podmínka, doèasnì pøidána èi odebrána kapacita zdroje). 

  Pokud bychom øe¹ili takto zmìnìný problém pomocí statického pøístupu ukázaného v~pøedchozí kapitole, bylo by nutné pøepoèítat celý rozvrh znovu od zaèátku, co¾ by si pøi øe¹ení vìt¹ích problémù vy¾ádalo znaèné mno¾ství èasu. Druhým problémem tohoto pøístupu je fakt, ¾e i relativnì malá zmìna v zadání by si mohla potenciálnì vy¾ádat veliké zmìny ve výsledném rozvrhu, co¾ je pøi pøi øe¹ení nìkterých problémù ne¾ádoucí.

  Pøístupem, na který se zamìøíme v této kapitole, je vyu¾ití pøedchozího øe¹ení, které je pomocí heuristických metod pøepracováno tak, aby vyhovovalo novému zadání \cite{jv:cs05}. Pøi tomto zpùsobu øe¹ení se ale mohou kritéria optimality øe¹ení a snaha o co nejmen¹í zmìny v rozvrhu ukázat jako nesluèitelné -- pak zvolíme metodu hledání øe¹ení podle toho, které kritérium preferujeme.

  Z pøede¹lého je zøejmé, ¾e dynamický rozvrhovací problém mù¾eme pova¾ovat za posloupnost nìkolika statických rozvrhovacích problémù, z nich¾ ka¾dý rozvrhovací problém je restrikcí resp. relaxací problému následujícího. Proto mù¾eme dynamický rozvrhovací problém formulovat jako dynamický problém splòování podmínek \cite{miguel:dyn04} tak, jak jsme jej definovali v kapitole \ref{chap:clp}.

  V této kapitole uká¾eme zpùsob øe¹ení dynamických rozvrhovacích problémù pomocí øe¹ièe knihovny \emph{repair}, který byl popsán v \ref{sec:repair}. Tento øe¹iè umo¾òuje pøiøazovat doménovým promìnným zku¹ební hodnoty (\emph{tentative value}) (tyto zku¹ební hodnoty mohou být bìhem bìhu programu mìnìny) a detekovat, zda a která omezení poslaná tomuto øe¹ièi jsou tímto pøiøazením poru¹ena. Dále uká¾eme výhody hybridního øe¹ièe, tedy propojení celoèíselného øe¹ièe, jeho¾ mo¾nosti byly ukázány v minulé kapitole, a øe¹ièe umo¾òujícího detekci nesplnìných omezení.

  
% - - - - - - - - -
  \section{Plánování projektu}
  \label{sec:dproj}

  Tento problém opìt slou¾il jako základ pro øe¹ení slo¾itìj¹ích problémù. Bude zde ukázáno, jak lze v systému \ecl{} vyu¾ít knihovnu \emph{repair} pro metodu lokálního prohledávání. Také uká¾eme, proè je výhodné propojit tento øe¹iè s \emph{ic} øe¹ièem, který byl pou¾it pro øe¹ení rozvrhovacích problémù v pøedchozí kapitole.

  \subsection{Popis problému}
  
  Mìjme øe¹ení problému plánování projektu popsaného v \ref{sec:project}. Do rozvrhu je pøidáno $m$ nových aktivit ($m$ mù¾e být obecnì rovno~0) a $n$ nových precedencí (i $n$ mù¾e být rovno 0). Na¹ím úkolem je pozmìnit rozvrh tak, aby vyhovoval novým i starým podmínkám, pøièem¾ kritérium optimality mù¾e být poru¹eno.

  \begin{priklad}
    Uva¾me problém skládající se z u¾ vypoèítaného rozvrhu s aktivitami $A_1, \dots , A_6$, jejich¾ doby zpracování jsou $p_1 = 3$, $p_2 = 1$, $p_3 = 5$, $p_4 = 2$, $p_5 = 4$ a $p_6 = 2$. V¹echny pùvodní aktivity mají èas dostupnosti $r_i=0$ a mezi aktivitami jsou následující precedenèní podmínky: $A_1 \ll A_4$, $A_3 \ll A_5$, $A_3 \ll A_6$ a $A_5 \ll A_6$. Øe¹ení pùvodního problému mù¾eme vidìt na obrázku \ref{fig:dyn_proj1}.

\begin{figure}[hbt]
\centering
\begin{minipage}{5in}
\centering
\includegraphics{figures/dyn_proj1.eps}
\caption{Øe¹ení pùvodního problému plánování projektu}
\label{fig:dyn_proj1}
\end{minipage}
\end{figure}    

Do rozvrhu byly pøidány dal¹í dvì aktivity $N_7$ a $N_8$, pro které platí $p_7 = 3$ a $r_7 = 8$ a $p_8 = 4$ a $r_8 = 8$.
Nové precedenèní podmínky $N_7 \ll A_1$, $A_3 \ll N_8$ a $N_8 \ll A_6$. Dvì rùzná øe¹ení nového problému jsou ukázána na obrázcích \ref{fig:dyn_proj2} a \ref{fig:dyn_proj3}.

\begin{figure}[hbt]
\centering
\begin{minipage}{6in}
\centering
\includegraphics{figures/dyn_proj2.eps}
\caption{Øe¹ení zmìnìného problému plánování projektu}
\label{fig:dyn_proj2}
\end{minipage}
\end{figure}    

\begin{figure}[hbt]
\centering
\begin{minipage}{6in}
\centering
\includegraphics{figures/dyn_proj3.eps}
\caption{Jiné øe¹ení zmìnìného problému plánování projektu}
\label{fig:dyn_proj3}
\end{minipage}
\end{figure}    
  \end{priklad}

Øe¹ení z obrázku \ref{fig:dyn_proj2} má dobu trvání 16 a poèet zmìn startovních èasù ji¾ rozvr¾ených aktivit je 3. Oproti tomu øe¹ení na obrázku \ref{fig:dyn_proj3} má stejnou dobu trvání, ale zmìn bylo vykonáno více (konkrétnì 5).

  \subsection{Model problému}

  Pøedchozí øe¹ení problému máme k dispozici jako výsledek pøede¹lého bìhu programu -- to znamená, ¾e v¹echny promìnné reprezentující bývalé aktivity jsou nainstanciovány na pøíslu¹né hodnoty. Pokud nyní chceme toto pøiøazení zmìnit, nezbývá ne¾ zkopírovat hodnoty v¹ech promìnných reprezentujících startovní èasy aktivit do nových promìnných, kterým pøiøadíme pøíslu¹nou \emph{tentative} hodnotu (viz popis knihovny \emph{repair} v \ref{sec:repair}). V systému \ecl{} toto zapí¹eme jako

        \begin{minipage}{\linewidth}
	  \begin{verbatim}

      ( foreach(Name-Start_Old-Duration,Tasks_Old),
        foreach(Name-Start-Duration,Tasks) do
        Start tent_set Start_Old )
          \end{verbatim}
	\end{minipage}
kde {\verb Tasks_Old } jsou aktivity z øe¹ení pøedchozího problému a {\verb Tasks } jsou odpovídající aktivity v souèasném problému. Ostatní hodnoty popisující ka¾dou jednotlivou aktivitu (jméno, doba trvání) jsou konstanty, èili je mù¾eme jednodu¹e zkopírovat.

  Proto¾e knihovna \emph{repair} zji¹»uje nesplnìní omezení, má smysl v jejím kontextu uva¾ovat pouze o promìnných, které v nìjakém monitorovaném omezení vystupují. V problému rozvrhování projektu vystupují jako jediné omezující podmínky precedence. Pokud chceme systému umo¾nit detekci nesplnìní omezení pøi pøiøazení \emph{tentative} hodnot, musíme pøíslu¹né omezení deklarovat jako omezení tohoto øe¹ièe. Pro seznam {\verb Precedences } v¹ech zadaných po¾adavkù na precedenèní podmínky tedy mù¾eme napsat 

	\begin{minipage}{\linewidth}
	  \begin{verbatim}

      ( foreach(X,Precedences) do 
        X = before(_-S1-D1,_-S2-_),
        S2 #>= S1 + D1 r_conflict precedences )
          \end{verbatim}
	\end{minipage}
kde atom {\verb precedences } slou¾í jako název mno¾iny omezení, která jsou øe¹ièem monitorována.

  Pøi implementaci lokálního prohledávání (popsáno dále) se ukázalo, ¾e algoritmus je mnohem ménì efektivní, pokud nejsou k dispozici dolní meze promìnných propagované aritmetickými omezením knihovny \emph{ic}. Proto byla nakonec pøidána i tato omezení, která nám poskytují dal¹í informace, které mù¾eme vyu¾ít pøi prohledávání.

  \subsection{Pou¾itá metoda prohledávání}
  
  Pro hledání øe¹ení bylo pou¾ito lokální prohledávání, konkrétnì metoda minimalizace konfliktù v kombinaci s náhodnou procházkou. Jádro algoritmu mù¾eme vidìt na obrázku \ref{fig:mcrw}.

  Algoritmus má stanoven poèet pokusù \verb|RestartLimit| na nalezení øe¹ení (restartù). K~restartu dojde, pokud je provedeno pøíli¹ mnoho zmìn -- maximální mo¾ný poèet zmìn pøi jednom pokusu je odvozen od poètu aktivit v rozvrhu. Èítaè zbývajícího poètu povolených zmìn je udr¾ován v \verb|Limit|. Nový pokus je také spu¹tìn, pokud je pøi prohledávání dosa¾eno lokálního optima vzhledem k poètu poru¹ených omezení, ale toto optimum není hledaným øe¹ením problému (øádek 15).
  Dal¹ím parametrem je pravdìpodobnost, ¾e algoritmus provede náhodnì zvolený krok, tj. uèiní výbìr náhodné hodnoty náhodnì zvolené konfliktní promìnné (viz øádek 6, kde je \verb|p| vhodnì zvolená konstanta odpovídající procentu náhodného kroku).

  Na zaèátku ka¾dé iterace je nejdøíve zji¹tìno, zda souèasné pøiøazení hodnot promìnným, které reprezentují startovní èasy aktivit, u¾ není konzistentní. Pokud je pøiøazení konzistentní, algoritmus konèí úspìchem a navrátí nalezené øe¹ení (øádek 3).

  Pokud souèasné pøiøazení není øe¹ením, je s danou pravdìpodobností vyzkou¹ena náhodná zmìna náhodné konfliktní promìnné (øádek 5-9). Pokud není pou¾ita náhodná procházka, pøichází na øadu minimalizace konfliktù -- náhodnì je zvolena konfliktní promìnná (øádek 11) a algoritmus zkusí minimalizovat poèet konfliktù tím, ¾e postupnì mìní hodnotu promìnné (predikát \verb|move/1| na øádku 12). Pokud nemù¾e být hodnota promìnné zmìnìna tak, aby bylo dosa¾eno men¹ího poètu konfliktù, volaný predikát sel¾e a je vybrána jiná promìnná (\emph{backtracking} zpìt na øádek 11). Pokud jsou vyzkou¹eny v¹echny konfliktní promìnné a není dosa¾eno zlep¹ení, prohledávání dosáhlo lokálního optima. Proto je spu¹tìn restart (øádek 15).

  Pøi restartu jsou startovním èasùm star¹ích aktivit pøiøazeny hodnoty odpovídající pùvodnímu øe¹ení. Startovním èasùm novì pøidaných aktivit jsou pøiøazeny náhodné hodnoty z jejich domén.

 \begin{figure}[hbt]
	\begin{minipage}{\linewidth}
	  \begin{tabular}{rl}
 & \verb|conflict_min(Old_Sol,New_Tasks,Tasks,Restart_Limit,Limit) :- |\\
$_{1:}$ & \verb|  poss_conflict_vars(precedences,List), |\\
$_{2:}$ & \verb|  Limit1 is Limit - 1, |\\
$_{3:}$ & \verb|  ( List=[] -> !, set_to_tent(Tasks) |\\
$_{4:}$ & \verb|  ; |\\
$_{5:}$ & \verb|    random(N), |\\
$_{6:}$ & \verb|    p > N mod 10000 -> |\\
$_{7:}$ & \verb|    random_member(List,Var), |\\
$_{8:}$ & \verb|    random_move(Var), |\\
$_{9:}$ & \verb|    !, conflict_min(Old_Sol,New_Tasks,Tasks,Restart_Limit,Limit1) |\\
$_{10:}$ & \verb|  ; |\\
$_{11:}$ & \verb|    random_member(List,C_Var), |\\
$_{12:}$ & \verb|    move(C_Var), |\\
$_{13:}$ & \verb|    !, conflict_min(Old_Sol,New_Tasks,Tasks,Restart_Limit,Limit1) |\\
$_{14:}$ & \verb|  ; |\\
$_{15:}$ & \verb|    conflict_min(Old_Sol,New_Tasks,Tasks,Restart_Limit,0) |\\
$_{16:}$ & \verb|  ). |
	  \end{tabular}
	\end{minipage}
	\caption{Minimalizace konfliktù s náhodnou procházkou}
	\label{fig:mcrw}
  \end{figure}

% - - - - - - - - -
  \section{Disjunktivní rozvrhování}
  \label{sec:ddisj}

  Problém rozvrhování na disjunktním zdroji jsme uvedli v \ref{sec:disj}, nyní jej opìt roz¹íøíme na dynamickou verzi. Uká¾eme zde, jakým zpùsobem je mo¾né pøistupovat k omezením na zdroji pøi pou¾ití øe¹ièe pro detekci poru¹ení omezení.

  \subsection{Popis problému}
    Problém dynamického rozvrhování na jednom stroji lze formulovat obdobnì jako v \ref{sec:dproj}. Máme mno¾inu aktivit s precedenèními podmínkami narozvrhovaných na jednom disjunktním stroji. Do rozvrhu je pøidáno $n$ nových aktivit a $m$ nových precedenèních omezení (i~nyní mù¾e být $n$ èi $m$ rovno 0). Úkolem je najít rozvrh vyhovující pøidaným i pùvodním podmínkám.

  \begin{priklad}
     Mìjme instanci problému obsahující a aktivity $A_1,A_2$ a $A_3$ s dobami trvání $p_1 = 5$, $p_2 = 3$ a $p_3 = 4$ a èasy dostupnosti $r_1 = 0$, $r_2 = 7$ a $r_3 = 2$. Problém dále obsahuje jednu precedenèní podmínku $A_1 \ll A_2$. Øe¹ení tohoto problému vidíme na obrázku \ref{fig:dyn_disj1}.
\begin{figure}[hbt]
\centering
\begin{minipage}{5in}
\centering
\includegraphics[width=4in]{figures/disj1.eps}
\caption{Øe¹ení pùvodního problému}
\label{fig:dyn_disj1}
\end{minipage}
\end{figure}

  Nyní uva¾me pøidání aktivit $N_4$ a $N_5$, s hodnotami $r_4 = 8$, $p_4 = 3$ a $r_5 = 10$, $p_5 = 2$ a precedenèních podmínek $A_2 \ll N_4$ a $N_5 \ll A_2$. Øe¹ení nového problému je ukázáno na obrázku \ref{fig:dyn_disj2}.

\begin{figure}[hbt]
\centering
\begin{minipage}{5in}
\centering
\includegraphics{figures/dyn_disj.eps}
\caption{Øe¹ení zmìnìného problému rozvrhování na disjunktním stroji}
\label{fig:dyn_disj2}
\end{minipage}
\end{figure}    
    \end{priklad}

  \subsection{Model}

  Pøi tvorbì modelu je vhodné uva¾ovat dopøedu nad zpùsobem, kterým budeme hledat øe¹ení. Jak jsme uvedli ji¾ u pøedchozího problému, lokální prohledávání mù¾e být zbyteènì neefektivní kvùli nedostateènému omezení domén promìnných. Pøi øe¹ení tohoto problému tedy také pou¾ijeme aritmetické podmínky pou¾ité u statických rozvrhovacích problémù pro modelování precedenèních vztahù -- tím dosáhneme zejména propagace dolních mezí domén promìnných. Jako omezení na zdroji mù¾eme pou¾ít omezení s nejsilnìj¹í propagací, proto¾e bìhem lokálního prohledávání nebude dále docházet k~propagaci a tedy zvy¹ovaní èasové nároènosti -- k propagaci podmínky dojde pouze pøi jejím zavedení do systému a pøi nalezení øe¹ení.
  
  Z pohledu knihovny \emph{repair} mù¾eme precedenèní podmínky zavést stejnì jako u pøedchozího problému. Pøi lokálním prohledávání by mohly být velice u¾iteèné informace o~poru¹ení podmínek na zdroji. Pokud ov¹em necháme celou globální podmínku \emph{disjunctive} monitorovat, budou v mno¾inì konfliktních promìnných vraceny i promìnné, které se na poru¹ení podmínky vùbec nepodílejí. Dùvodem je to, ¾e v tomto omezení se úèastní v¹echny promìnné. Toto je problém, který souvisí právì s celkovým pohledem na podmínku -- podmínka je buï poru¹ená nebo splnìná, a tedy i v¹echny v ní figurující promìnné jsou buï konfliktní nebo nekonfliktní. V rámci práce byl tedy navr¾en zpùsob, jak získat právì tyto informace o~kritických místech na zdroji.

  Základní my¹lenkou je pou¾ití mechanismu \emph{Time-Table Constraint} \cite{baptpanui:cbs01}, který pou¾ívá explicitní vyjádøení bìhu aktivit pro propagaci omezujících podmínek na zdrojích -- výhoda tohoto zpùsobu reprezentace zdroje vynikne pøi uva¾ování kumulativního zdroje v \ref{sec:dyn_rcpsp}. Oznaème $X(A_i,t)$ logickou promìnnou, která nabývá hodnoty $1$ právì tehdy, kdy¾ je aktivita $A_i$ zpracovávána v èase $t$. Formálnì:
  \[ \forall t: X(A_i,t) = 1 \Leftrightarrow start_i \leq t < end_i \text{ pro v¹echny aktivity } A_i \]
  Disjunktní omezení lze pak pøepsat na
  \[ \forall t: \sum_{i = 1}^{m+n} X(A_i,t)\leq 1 \]

  Ka¾dou aktivitu tedy lze reprezentovat polem promìnných s doménou $\{0,1\}$. Pøi prohledávání budou startovní èasy mìnìny a tato pole musí být udr¾ována konzistentní. K tomuto úèelu byl implementován predikát, který pøi zmìnì zku¹ební hodnoty promìnné reprezentující startovní èas aktivity nastaví pøíslu¹né pole tak, aby odpovídalo souèasné zku¹ební hodnotì promìnné. Abychom vyu¾ili výhody pøímého pøístupu k jednotlivým prvkùm pole, je nutné si uchovávat informaci o pøedchozí zku¹ební hodnotì právì zmìnìné promìnné (bez znalosti pøedchozí hodnoty bychom museli procházet celé pole). Pro tento úèel jsme pou¾ili globální promìnnou, která uchovává informaci o pøedchozí hodnotì poslednì mìnìné promìnné.

  Kvùli odli¹ení konfliktù s precedenèními podmínkami a omezeními na zdroji jsme pou¾ili dvì rùzné konfliktní mno¾iny.
  
  \subsection{Pou¾itá metoda prohledávání}

  Pro hledání øe¹ení pou¾ijeme podobnou metodu jako v \ref{sec:ddisj} -- bude se také jednat o minimalizaci konfliktù s náhodnou procházkou.
  
  Problém obsahuje dvì rozdílné mno¾iny omezení. Dùle¾ité je, ¾e zatímco precedenèní omezení jsou svázaná pøímo s promìnnými reprezentujícími startovní èasy aktivit, omezezení na zdroji jsou nad promìnnými $X(A_i,t)$ reprezentujícími èasové okam¾iky. Konfliktních promìnných pøi jednom konfliktu na zdroji mù¾e být tedy øádovì více ne¾ pøi jednom precedenèním konfliktu. Dále je také potøebné konfliktní promìnné reprezentující èasové okam¾iky bìhu aktivit filtrovat -- v konfliktu jsou i promìnné aktivit, které v daném okam¾iku vùbec nebì¾í. Proto tedy máme dvì základní mo¾nosti, jak prohledávání realizovat:
\begin{itemize}
\item  Algoritmus lokálního prohledávání nejprve odstraní konflikty s precedenèními podmínkami -- postup je stejný jako døíve. Pokud u¾ promìnné nejsou v tìchto konfliktech, je mo¾né zkusit minimalizovat konflikty na zdroji. Toto poøadí je zvoleno právì kvùli mo¾nosti jemnìj¹ího rozli¹ování konfliktù na zdroji
\item Precedenèní konflikty i konflikty na zdrojích jsou odstaòovány zároveò -- precedenèním konfliktùm je pøiøazena vy¹¹í váha.
\end{itemize}
% - - - - - - - - -
  \section{RCPSP}
  \label{sec:dyn_rcpsp}

  Posledním problémem, na kterém uká¾eme mo¾nosti knihovny \emph{repair}, bude rozvrhování na jednom kumulativním zdroji.
  
  Mìjme mno¾inu aktivit s precedenèními podmínkami rozvrhovaných na jednom kumulativním zdroji zpùsobem popsaným v \ref{sec:rcpsp}. Do rozvrhu je pøidáno $n$ nových aktivit s $m$ novými precedenèními podmínkami. Úkolem je opìt najít rozvrh vyhovující pøidaným i pùvodním podmínkám.

  \subsection{Model a metoda hledání øe¹ení}

    Pøi øe¹ení tohoto problému vyu¾ijeme opìt propojení øe¹ièù døíve prezentovaným zpùsobem. Precedenèní omezení namodelujeme známým zpùsobem. Jako omezení na zdroji zvolíme omezení \emph{cumulative} s nejsilnìj¹í propagací, které nabízí knihovna \emph{edge\_finder3}.

    V \ref{sec:ddisj} jsme ukázali, jak zachytit disjunktní omezení pomocí \emph{repair} knihovny tak, aby bylo mo¾né získávat relevantní informace o konfliktech na zdroji. Krok ke kumulativnímu zdroji je jednoduchý -- místo aritmetického souètu pou¾ijeme vá¾ený souèet, kde váha ka¾dé aktivity bude její po¾adavek na kapacitu zdroje. Formálnì:
 \[ \forall t: \sum_{i = 1}^{m+n} X(A_i,t) cap_i\leq resource \]
    Implementace tohoto postupu je obdobná jako u disjunktního zdroje.

    Prohledávací strategie je stejná jako v pøedchozím pøípadì -- minimalizace konfliktù s náhodnou procházkou. I zde máme celkem dvì mo¾nosti, jak minimalizovat konflikty -- nejprve vyøe¹it precedenèní podmínky a následnì posunováním aktivit v èase minimalizovat konflikty nebo øe¹it oba typy konfliktù zároveò. Dùvody jsou stejné jako v pøede¹lém pøípadì.

%------------------------------------
\chapter{Experimentální výsledky}

\renewcommand{\figurename}{Obr. }

  V této kapitole budou prezentovány výsledky namìøené na konkrétních instancích øe¹ených problémù. V¹echna mìøení byla provedena pod operaèním systémem Linux na stroji s procesorem Athlon XP 2500+ a pamìtí 768MB RAM. Uvedené èasy odpovídají dobì bìhu procesu na procesoru -- nejsou zkreslené vytí¾ením stroje. Generátory instancí problémù byly naprogramovány v jazyce Java.

\section{Statické problémy}

  Výsledky byly pro ka¾dý problém a poèet aktivit namìøeny na pìti instancích.

  Instance problému plánování projektu a rozvrhování na jednom disjunktním zdroji jsou tvoøeny aktivitami s maximální dobou trvání 5 èasových jednotek. Mezi ka¾dými dvìma aktivitami je precedenèní podmínka s pravdìpodobností {10\,\%} -- pro $n$ aktivit je tedy precedenèních podmínek prùmìrnì $n(n-1)/20$. Jako kriterium optimality byl pou¾it po¾adavek minimalizace celkového trvání rozvrhu, tj. minimalizace \emph{makespan}.

  Výsledky pro problém plánování projektu jsou zobrazeny na obrázku \ref{fig:e_proj}. Pro men¹í instance o 100 úlohách byla doba øe¹ení problému v rozmezí $0.01-0.02$ sekundy, pro nejvìt¹í problémy obsahující 900 aktivit bì¾el program v prùmìru $19.87$ sekund. Z grafu je patrné, ¾e doba bìhu je úmìrná poètu precedenèních omezení v rozvrhu.

  Na obrázku \ref{fig:e_disj} mù¾eme vidìt èasy namìøené pøi øe¹ení instancí rozvrhování na disjunktním zdroji. Pøi øe¹ení problému pro 100 aktivit bylo dosa¾eno prùmìrného èasu $0.44$ sekund, pro 900 úloh byla doba bìhu v prùmìru $208.56$ vteøiny. Nárùst doby bìhu oproti problému plánování projektu je zpùsoben hledáním promìnné s nejmen¹ím prvkem v doménì v ka¾dém kroku prohledávací procedury a následnou propagací disjunktního omezení na zdroji.
%
\begin{figure}[htb]
\begin{minipage}{.5\textwidth}
\centering
\includegraphics[width=2.5in]{figures/p.ps}
\caption{Doba bìhu pro problém plánování projektu}
\label{fig:e_proj}
\end{minipage}
\begin{minipage}{.5\textwidth}
\centering
\includegraphics[width=2.5in]{figures/d.ps}
\caption{Doba bìhu pro rozvrhování na jednom disjunktivním zdroji}
\label{fig:e_disj}
\end{minipage}
\end{figure}    
%
  \emph{Job Shop Problem} a RCPSP jsou tì¾ké optimalizaèní problémy a pro jejich výpoèet bylo nutno nastavit prohledávací proceduøe èasový limit -- v obou pøípadech bylo zvoleno 10\,minut. Pro porovnání výsledkù namìøených pro rùznì velké instance problémù bylo zvoleno kritérium optimality -- \emph{makespan}.

  Instance \emph{Job Shop Problem} obsahují 100, 200 a 300 úloh rozvrhovaných na pìti strojích (celkem tedy 500, 1000 a 1500 promìnných reprezentujících startovní èasy operací na strojích). Délka ka¾dé operace je náhodnì zvolena z intervalu $\langle 1,5 \rangle$. Z grafu na obrázku \ref{fig:e_jobs} mù¾eme vidìt, ¾e cena nalezených øe¹ení je úmìrná poètu úloh v problému.

  Výsledky pro RCPSP jsou zachyceny na obrázku \ref{fig:e_rcpsp}. Mìøení bylo provádìno pro dva kumulativní zdroje o kapacitách 8 a 4. Úlohy byly uspoøádány do posloupností svázaných precedenènímu podmínkami, ka¾dá posloupnost obsahuje 5 úloh. Doby trvání jsou zvoleny jako u pøedchozích problémù. Ka¾dá aktivita po¾aduje pøi svém bìhu a¾ polovinu kapacity obou zdrojù, tj. 4 jednotky prvního a 2 druhého zdroje (po¾adavky na zdroje byly opìt generovány náhodnì). Na grafu mù¾eme vidìt, ¾e délka trvání rozvrhu opìt odpovídá poètu rozvrhovaných aktivit -- pøesto¾e se poèet aktivit zvy¹uje a dochází k vìt¹í èasové nároènosti propagace kumulativních omezení. Tento jev lze vysvìtlit tím, ¾e pøi vìt¹ím poètu mo¾ností lze aktivity na zdrojích lépe uspoøádat, tj. narozvrhovat tak, aby lépe vyu¾ily kapacity zdrojù.

\section{Dynamické problémy}

  Výsledky byly pro ka¾dý problém a poèet pøidaných aktivit namìøeny na pìti instancích. Doba trvání ka¾dé rozvrhované aktivity je celé èíslo náhodnì zvolené z intervalu $\langle 1,5 \rangle$.

  Na obrázku \ref{fig:e_dproj} jsou zobrazeny výsledky namìøené pro dynamický problém plánování projektu. Rozvrh pùvodnì obsahoval 100 úloh s precedenèními podmínkami. Do rozvrhu pøidáme 10, 15 a 20 nových aktivit a také precedenèní omezení tak, ¾e pro ka¾dou dvojici pùvodní a nová aktivita se toto omezení pøidá s pravdìpodobností 5\'\% a urèuje, ¾e nová aktivita musí být provádìna pøed pùvodní aktivitou. Na grafu vidíme závislost doby bìhu na poètu pøidaných aktivit.

  Instance dynamického RCPSP obsahují 50 úloh rozvrhovaných na kumulativním zdroji o~kapacitì 8. Mezi ka¾dými dvìma úlohami je s pravdìpodobností 5\,\% precedenèní podmínka. Po¾adovaná kapacita ka¾dé aktivity je generována z intervalu $\langle 1,4 \rangle$. Do rozvrhu jsou pøidány aktivity, které jsou uspoøádány do posloupnosti precedenèními podmínkami. Dobu bìhu v závislosti na poètu pøidaných aktivit mù¾eme vidìt na obrázku \ref{fig:e_drcpsp}. Pøi pøidání tøí nových aktivit byla provedena nejvý¹e jedna zmìna startovního èasu ji¾ narozvrhované promìnné, zatímco pøi pøidání sedmi aktivit byly v prùmìru provedeny tøi takové zmìny.

\begin{figure}[t]
\begin{minipage}{.5\textwidth}
\centering
\includegraphics[width=2.5in]{figures/j.ps}
\caption{Dosa¾ený \emph{makespan} pro \emph{Job Shop}}
\label{fig:e_jobs}
\end{minipage}
\begin{minipage}{.5\textwidth}
\centering
\includegraphics[width=2.5in]{figures/rp.ps}
\caption{Dosa¾ený \emph{makespan} pro RCPSP}
\label{fig:e_rcpsp}
\end{minipage}
\end{figure}
%
\begin{figure}[b]
\begin{minipage}{.5\textwidth}
\centering
\includegraphics[width=2.5in]{figures/dp.ps}
\caption{Doba bìhu pro dynamický problém plánování projektu}
\label{fig:e_dproj}
\end{minipage}
\begin{minipage}{.5\textwidth}
\centering
\includegraphics[width=2.5in]{figures/drp.ps}
\caption{Doba bìhu pro dynamický RCPSP}
\label{fig:e_drcpsp}
\end{minipage}
\end{figure}
\clearpage

%------------------------------------
\chapter{Závìr}

  V rámci práce byl navr¾en a prezentován soubor reprezentativních problémù z oblasti statického a dynamického rozvrhování. V¹echny problémy byly jednotným zpùsobem popsány tak, ¾e bylo uvedeno zadání problému, jeho pøíklad, popsán model problému, mo¾nosti jeho øe¹ení a implementace pomocí prostøedkù systému pro logické programování s omezujícími podmínkami \ecl{}. Statické rozvrhovací problémy byly øe¹eny pomocí klasických metod prostøednictvím knihovny s omezujícími podmínkami nad koneènými doménami a intervaly a prohledávání pomocí \emph{backtrackingu} a metody vìtví a mezí s propagacemi omezení. K øe¹ení dynamických problémù byl pou¾it hybridní pøístup k øe¹ení, který propojuje øe¹iè pracující nad koneènými doménami a knihovnu umo¾òující detekci nesplnìných omezení. Pro øe¹ení dynamických problému disjunktivního rozvrhování a \emph{Resource-Constraint Project Scheduling Problem} bylo navr¾eno pou¾ití metody \emph{Time-Table Constraint}, které poskytuje dále vyu¾itelné informace o konfliktech na zdrojích. Proto¾e si nejsme vìdomi, ¾e by tato metoda byla ji¾ døíve pøi øe¹ení dynamických rozvrhovacích problémù pou¾ita, bylo by vhodné se podrobnìji vìnovat jejímu studiu.

  V rámci budoucí práce by bylo vhodné provést rozsáhlej¹í experimety, a to zejména pro dynamické problémy. Bylo by zajímavé roz¹íøit sadu øe¹ených problémù a implementovat dal¹í algoritmy pro uva¾ované problémy. Dále je mo¾né se vìnovat ji¾ zmínìnému studiu a zefektivnìní implementace metody \emph{Time-Table Constraint} pro øe¹ení dynamických rozvrhovacích problémù.

%------------------------------------
\newpage
\phantomsection
\bibliographystyle{plain}
\bibliography{literatura}
\addcontentsline{toc}{chapter}{\bfseries Literatura}

%------------------------------------
\appendix

\chapter{Obsah pøilo¾eného CD}

  Pøilo¾ené CD je strukturováno jako webová stránka zaèínající na \emph{index.html} v koøenovém adresáøi. CD obsahuje tento dokument ve formátech \emph{portable data format (pdf)} a \emph{postscript (ps)} a jeho zdrojový kód v~systému \LaTeX. Dále jsou zde zdrojové kódy popsaných problémù psané v \ecl{}, generátory problémù v jazyce Java a instance problémù, na kterých byly provádìny experimenty.

\end{document}

